<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audiencias - Agenda Legal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="css/styles.css"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="sidebar-container"></div>

  <div class="main-content">
    <div class="container">
      <header>
        <div class="header-content">
          <h1><i class="fas fa-gavel"></i> Audiencias - Agenda Legal</h1>
          <div class="user-info">
            <i class="fas fa-user-circle"></i> Usuario Abogado
          </div>
        </div>
      </header>

      <div class="tab-content active" id="audiencias">
        <div class="toolbar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="search-audiencias" placeholder="Buscar en audiencias...">
          </div>
          <div class="toolbar-buttons" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-success" id="export-audiencias" title="Exportar a Excel">
              <i class="fas fa-file-excel"></i> Exportar Excel
            </button>
            <button class="btn btn-primary" id="add-audiencia">
              <i class="fas fa-plus"></i> Nueva Audiencia
            </button>
          </div>
        </div>

        <div class="filters">
          <div class="filters-title"><i class="fas fa-filter"></i> Filtros de Audiencias</div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter-tipo">Tipo de Audiencia</label>
              <select id="filter-tipo">
                <option value="">Todos los tipos</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="filter-gerencia">Gerencias</label>
              <div class="gerencia-search-container">
                <input type="text" id="filter-gerencia" placeholder="Buscar estado..." autocomplete="off">
                <div class="gerencia-suggestions" id="gerencia-suggestions"></div>
                <button type="button" class="btn-clear-gerencia" id="clear-gerencia" title="Limpiar filtro">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <div class="filter-group">
              <label for="filter-materia">Materia</label>
              <select id="filter-materia">
                <option value="">Todas las materias</option>
                <option value="Civil">Civil</option>
                <option value="Penal">Penal</option>
                <option value="Laboral">Laboral</option>
                <option value="Mercantil">Mercantil</option>
                <option value="Fiscal">Fiscal</option>
                <option value="Familiar">Familiar</option>
                <option value="Administrativo">Administrativo</option>
                <option value="Constitucional">Constitucional</option>
                <option value="Amparo">Amparo</option>
                <option value="Transparencia">Unidad de Transparencia</option>
                <option value="Agrario">Agrario</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="filter-prioridad">Prioridad</label>
              <select id="filter-prioridad">
                <option value="">Todas las prioridades</option>
                <option value="Alta">Alta</option>
                <option value="Media">Media</option>
                <option value="Baja">Baja</option>
              </select>
            </div>
          </div>
        </div>

        <div class="table-container">
          <table id="tabla-audiencias">
                <thead>
                <tr>
                    <th></th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Tribunal</th>
                    <th>Expediente</th>
                    <th>Actor</th>
                    <th>Acciones</th>
                </tr>
                </thead>
            <tbody id="audiencias-body">
              </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-audiencia">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-audiencia-title">Nueva Audiencia</h2>
        <button class="btn btn-danger" id="close-modal-audiencia"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <form id="form-audiencia">
          <input type="hidden" id="audiencia-id"/>

          <div class="form-group">
            <label for="asunto-selector-audiencia">Asunto *</label>
            <select id="asunto-selector-audiencia" required>
              <option value="">Seleccionar Asunto</option>
            </select>
          </div>

          <fieldset class="auto-filled-section">
            <legend>Datos del Asunto (Auto-llenados)</legend>
            <div class="form-row">
              <div class="form-group">
                <label for="expediente-auto-audiencia">Expediente</label>
                <input type="text" id="expediente-auto-audiencia" class="readonly-field" readonly>
              </div>
              <div class="form-group">
                <label for="materia-auto-audiencia">Materia</label>
                <input type="text" id="materia-auto-audiencia" class="readonly-field" readonly>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="gerencia-auto-audiencia">Gerencia</label>
                <input type="text" id="gerencia-auto-audiencia" class="readonly-field" readonly>
              </div>
              <div class="form-group">
                <label for="abogado-auto-audiencia">Abogado Responsable</label>
                <input type="text" id="abogado-auto-audiencia" class="readonly-field" readonly>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="partes-auto-audiencia">Partes Procesales</label>
                <input type="text" id="partes-auto-audiencia" class="readonly-field" readonly>
              </div>
              <div class="form-group">
                <label for="organo-auto-audiencia">Órgano Jurisdiccional</label>
                <input type="text" id="organo-auto-audiencia" class="readonly-field" readonly>
              </div>
            </div>
            <div class="form-group">
              <label for="prioridad-auto-audiencia">Prioridad del Asunto</label>
              <input type="text" id="prioridad-auto-audiencia" class="readonly-field" readonly>
            </div>
          </fieldset>

          <fieldset class="user-input-section">
            <legend>Datos Específicos de la Audiencia</legend>

            <div class="form-group">
              <label for="tipo-audiencia">Tipo de Audiencia *</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <select id="tipo-audiencia" required style="flex:1;">
                  <option value="">Seleccione un tipo</option>
                </select>
                <button type="button" class="btn btn-info btn-sm" id="manage-tipos-btn" title="Gestionar tipos">
                  <i class="fas fa-tags"></i>
                </button>
              </div>
              <small>Si no encuentras el tipo, añádelo con “Gestionar tipos”.</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="fecha-audiencia">Fecha de Audiencia *</label>
                <input type="date" id="fecha-audiencia" required>
              </div>
              <div class="form-group">
                <label for="hora-audiencia">Hora de Audiencia *</label>
                <input type="time" id="hora-audiencia" required>
              </div>
            </div>

            <div class="form-group">
              <label for="sala-audiencia">Sala/Lugar de Audiencia</label>
              <input type="text" id="sala-audiencia" placeholder="Ej. Sala 2, Planta Baja">
            </div>

            <div class="form-group">
              <label for="abogado-comparece">Abogado que Comparece *</label>
              <select id="abogado-comparece" required>
                <option value="">Seleccione un abogado</option>
                </select>
            </div>

            <div class="form-group" style="display: none;">
              <label for="acta-audiencia">Acta de Audiencia (Archivo)</label>
              <div class="file-upload-container">
                <input type="file" id="acta-audiencia" accept=".pdf,.doc,.docx" class="file-input">
                <label for="acta-audiencia" class="file-upload-btn">
                  <i class="fas fa-file-upload"></i> Subir Acta de Audiencia
                </label>
                <span class="file-name" id="acta-filename">Ningún archivo seleccionado</span>
              </div>
            </div>

            <div class="form-group" style="display: none;">
              <label for="atendida">¿Atendida?</label>
              <select id="atendida">
                <option value="false">No</option>
                <option value="true">Sí</option>
              </select>
            </div>

            <div class="form-group" style="display: none;">
              <label for="observaciones">Observaciones</label>
              <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales sobre la audiencia..."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="recordatorio-dias">Recordatorio Días Antes</label>
                <input type="number" id="recordatorio-dias" min="1" value="1" placeholder="Ej. 7 días">
                <small>Por defecto: 1 día antes</small>
              </div>
              <div class="form-group">
                <label for="recordatorio-horas">Recordatorio Horas Antes</label>
                <input type="number" id="recordatorio-horas" min="1" value="2" placeholder="Ej. 24 horas">
                <small>Por defecto: 2 horas antes</small>
              </div>
            </div>

          </fieldset>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" id="cancel-audiencia">Cancelar</button>
        <button class="btn btn-success" id="save-audiencia">Guardar Audiencia</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-comentarios">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h2>Comentarios de la audiencia</h2>
        <button class="btn btn-danger" id="close-modal-comentarios"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="comentarios-audiencia-id">
        <div class="form-group">
          <label for="nuevo-comentario">Nuevo comentario</label>
          <textarea id="nuevo-comentario" rows="3" placeholder="Escribe tu comentario..."></textarea>
        </div>
        <div class="modal-footer" style="padding-left:0;">
          <button class="btn btn-success" id="save-comentario"><i class="fas fa-paper-plane"></i> Guardar comentario</button>
        </div>
        <hr>
        <div>
          <h3 style="margin-top:0;">Historial</h3>
          <ul id="lista-comentarios" class="comment-list" style="list-style:none; padding-left:0; margin:0;"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-finalizar-audiencia">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h2>Desahogar Audiencia</h2>
        <button class="btn btn-danger" id="close-modal-finalizar"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="finalizar-audiencia-id">
        <div class="alert-warning" style="background:#fff3cd;border:1px solid #ffeaa7;padding:15px;border-radius:5px;margin-bottom:20px;">
          <h3 style="margin:0 0 10px 0;color:#856404;">¿Confirmas que la audiencia fue desahogada?</h3>
          <p style="margin:0;color:#856404;">La audiencia cambiará su estatus a "Desahogada" y se mostrará en la Agenda General.</p>
        </div>
        <div class="form-group">
          <label for="observaciones-finales">Observaciones / Resumen *</label>
          <textarea id="observaciones-finales" rows="4" placeholder="Escribe un breve resumen o las observaciones de la audiencia..." required></textarea>
          <small>Las observaciones son obligatorias para desahogar la audiencia.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="cancel-finalizar">Cancelar</button>
        <button class="btn btn-success" id="confirmar-finalizar"><i class="fas fa-check"></i> Confirmar Desahogo</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-tipos-audiencia">
    <div class="modal-content" style="max-width:650px;">
      <div class="modal-header">
        <h2>Gestionar tipos de audiencia</h2>
        <button class="btn btn-danger" id="close-modal-tipos"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-row" style="grid-template-columns:1fr auto;">
          <div class="form-group" style="margin-bottom:0;">
            <label for="nuevo-tipo-audiencia">Nuevo tipo</label>
            <input type="text" id="nuevo-tipo-audiencia" placeholder="Ej. Audiencia de conciliación">
          </div>
          <div class="form-group" style="margin-bottom:0; align-self:end;">
            <button class="btn btn-success" id="add-tipo-btn"><i class="fas fa-plus"></i> Agregar</button>
          </div>
        </div>

        <hr style="margin:16px 0;">
        <h3 style="margin:0 0 10px 0;">Lista de tipos</h3>
        <ul id="lista-tipos-audiencia" style="list-style:none; padding-left:0; margin:0;"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="cancel-tipos">Cerrar</button>
        <button class="btn btn-success" id="save-tipos">Guardar cambios</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-historial-cambios">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h2>Historial de cambios</h2>
        <button class="btn btn-danger" id="close-modal-historial"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Audiencia</label>
          <input type="text" class="readonly-field" readonly value="(Demo) ID seleccionado">
        </div>
        <hr>
        <ul style="list-style:none; padding-left:0; margin:0;">
          <li style="padding:8px 0; border-bottom:1px solid #eee;">
            <strong>Pedrito Sola</strong> cambió <em>Hora</em> de <code>10:00</code> a <code>11:30</code> — <small>2025-11-03 14:22</small>
          </li>
          <li style="padding:8px 0; border-bottom:1px solid #eee;">
            <strong>Lic. Carlos H. López</strong> adjuntó <em>Acta de audiencia</em> — <small>2025-11-02 09:10</small>
          </li>
          <li style="padding:8px 0;">
            <strong>Admin</strong> creó la audiencia — <small>2025-11-01 16:05</small>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="cancel-historial">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-reasignar-audiencia">
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h2 id="modal-reasignar-title-audiencia">Reasignar Audiencia</h2>
              <button class="btn btn-danger" id="close-modal-reasignar-audiencia">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          <div class="modal-body">
              <form id="form-reasignar-audiencia">
                  <input type="hidden" id="reasignar-audiencia-id">
                  
                  <div class="form-group">
                      <label>Audiencia (Tipo):</label>
                      <input type="text" id="reasignar-tipo-audiencia" readonly class="readonly-field">
                  </div>
                  <div class="form-group">
                      <label>Abogado que Comparece (Actual):</label>
                      <input type="text" id="reasignar-abogado-actual-audiencia" readonly class="readonly-field">
                  </div>
                  
                  <div class="form-group">
                      <label for="select-nuevo-abogado-audiencia">Asignar a (Nuevo Abogado):*</label>
                      <select id="select-nuevo-abogado-audiencia" required>
                          <option value="">Seleccione un abogado...</option>
                          </select>
                  </div>
              </form>
          </div>
          <div class="modal-footer">
              <button class="btn btn-danger" id="cancel-reasignar-audiencia">Cancelar</button>
              <button class="btn btn-success" id="save-reasignar-audiencia">Confirmar Reasignación</button>
          </div>
      </div>
  </div>
  <script src="js/excel-export.js"></script>
  <script src="js/notificaciones.js"></script>
  <script src="js/components.js"></script>
  
  <script src="js/audiencias.js"></script>

  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Cargar sidebar y marcar la página activa
          if (typeof loadSidebar === 'function') {
              loadSidebar('audiencias.html');
          }
          
          // Inicializar la página de audiencias (esto llama a todo desde audiencias.js)
          if (typeof initAudiencias === 'function') {
              initAudiencias();
          }

          // Inicializar la exportación
          initExportacionAudiencias();
      });

      function initExportacionAudiencias() {
          // Configurar botón de exportar a Excel
          const btnExportAudiencias = document.getElementById('export-audiencias');
          if (btnExportAudiencias) {
              btnExportAudiencias.addEventListener('click', function() {
                  console.log('Iniciando exportación de audiencias...');
                  // Esta función 'exportarAudienciasAExcel' debe existir en tu 'excel-export.js'
                  if (typeof exportarAudienciasAExcel === 'function') {
                      exportarAudienciasAExcel();
                  } else {
                      alert('Error: La función de exportación no está disponible.');
                      console.error('Función exportarAudienciasAExcel no encontrada');
                  }
              });
          } else {
              console.warn('Botón export-audiencias no encontrado');
          }
      }
  </script>
  </body>
</html>