<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiencias - Agenda Legal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="sidebar-container"></div>
    
    <div class="main-content">
        <div class="container">
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-gavel"></i> Audiencias - Agenda Legal</h1>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i> Usuario Abogado
                    </div>
                </div>
            </header>
            
            <div class="tab-content active" id="audiencias">
                <div class="toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-audiencias" placeholder="Buscar en audiencias...">
                    </div>
                    <div class="toolbar-buttons">
                        <button class="btn btn-success" id="export-audiencias" title="Exportar a Excel">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button class="btn btn-primary" id="add-audiencia">
                            <i class="fas fa-plus"></i> Nueva Audiencia
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filters-title">
                        <i class="fas fa-filter"></i> Filtros de Audiencias
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filter-tipo">Tipo de Audiencia</label>
                            <select id="filter-tipo">
                                <option value="">Todos los tipos</option>
                                <option value="Inicial">Inicial</option>
                                <option value="Intermedia">Intermedia</option>
                                <option value="Ratificación">Ratificación</option>
                                <option value="Admisión">Admisión</option>
                                <option value="Confesional">Confesional</option>
                                <option value="Testimonial">Testimonial</option>
                                <option value="Reanudacion">Reanudación</option>
                                <option value="Incidental">Incidental</option>
                                <option value="Constitucional">Constitucional</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-gerencia">Gerencias</label>
                            <div class="gerencia-search-container">
                                <input type="text" 
                                       id="filter-gerencia" 
                                       placeholder="Buscar estado..."
                                       autocomplete="off">
                                <div class="gerencia-suggestions" id="gerencia-suggestions">
                                    </div>
                                <button type="button" class="btn-clear-gerencia" id="clear-gerencia" title="Limpiar filtro">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filter-materia">Materia</label>
                            <select id="filter-materia">
                                <option value="">Todas las materias</option>
                                <option value="Civil">Civil</option>
                                <option value="Penal">Penal</option>
                                <option value="Laboral">Laboral</option>
                                <option value="Mercantil">Mercantil</option>
                                <option value="Fiscal">Fiscal</option>
                                <option value="Familiar">Familiar</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Constitucional">Constitucional</option>
                                <option value="Amparo">Amparo</option>
                                <option value="Transparencia">Unidad de Transparencia</option>
                                <option value="Agrario">Agrario</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-prioridad">Prioridad</label>
                            <select id="filter-prioridad">
                                <option value="">Todas las prioridades</option>
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="tabla-audiencias">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Tribunal</th>
                                <th>Expediente</th>
                                <th>Actor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>    
                    <tbody id="audiencias-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="modal-audiencia">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-audiencia-title">Nueva Audiencia</h2>
                <button class="btn btn-danger" id="close-modal-audiencia">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-audiencia">
                    <input type="hidden" id="audiencia-id">

                    <div class="form-group">
                        <label for="asunto-selector-audiencia">Asunto *</label>
                        <select id="asunto-selector-audiencia" required>
                            <option value="">Seleccionar Asunto</option>
                        </select>
                    </div>

                    <fieldset class="auto-filled-section">
                        <legend>Datos del Asunto (Auto-llenados)</legend>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expediente-auto-audiencia">Expediente</label>
                                <input type="text" id="expediente-auto-audiencia" class="readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label for="materia-auto-audiencia">Materia</label>
                                <input type="text" id="materia-auto-audiencia" class="readonly-field" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="gerencia-auto-audiencia">Gerencia</label>
                                <input type="text" id="gerencia-auto-audiencia" class="readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label for="abogado-auto-audiencia">Abogado Responsable</label>
                                <input type="text" id="abogado-auto-audiencia" class="readonly-field" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="partes-auto-audiencia">Partes Procesales</label>
                                <input type="text" id="partes-auto-audiencia" class="readonly-field" readonly>
                            </div>
                            <div class="form-group">
                                <label for="organo-auto-audiencia">Órgano Jurisdiccional</label>
                                <input type="text" id="organo-auto-audiencia" class="readonly-field" readonly>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="prioridad-auto-audiencia">Prioridad del Asunto</label>
                            <input type="text" id="prioridad-auto-audiencia" class="readonly-field" readonly>
                        </div>
                    </fieldset>

                    <fieldset class="user-input-section">
                        <legend>Datos Específicos de la Audiencia</legend>
                        
                        <div class="form-group">
                            <label for="tipo-audiencia">Tipo de Audiencia *</label>
                            <select id="tipo-audiencia" required>
                                <option value="">Seleccione un tipo</option>
                                <option value="Inicial">Inicial</option>
                                <option value="Intermedia">Intermedia</option>
                                <option value="Ratificación">Ratificación</option>
                                <option value="Admisión">Admisión</option>
                                <option value="Confesional">Confesional</option>
                                <option value="Reanudacion">Reanudación</option>
                                <option value="Incidental">Incidental</option>
                                <option value="Constitucional">Constitucional</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha-audiencia">Fecha de Audiencia *</label>
                                <input type="date" id="fecha-audiencia" required>
                            </div>
                            <div class="form-group">
                                <label for="hora-audiencia">Hora de Audiencia *</label>
                                <input type="time" id="hora-audiencia" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="abogado-comparece">Abogado que Comparece *</label>
                            <select id="abogado-comparece" required>
                                <option value="">Seleccione un abogado</option>
                                <option value="1">Lic. María González Ruiz</option>
                                <option value="2">Lic. Carlos Hernández López</option>
                                <option value="3">Lic. Ana Patricia Morales</option>
                                <option value="4">Lic. Roberto Silva Martínez</option>
                                <option value="5">Lic. Sandra Jiménez Castro</option>
                                <option value="6">Lic. Fernando Ramírez Torres</option>
                                <option value="7">Lic. Carmen Delgado Vázquez</option>
                                <option value="8">Lic. Alejandro Mendoza Ruiz</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="acta-documento">Acta de Audiencia (Archivo)</label>
                            <div class="file-upload-container">
                                <input type="file" id="acta-documento" accept=".pdf,.doc,.docx" class="file-input">
                                <label for="acta-documento" class="file-upload-btn">
                                    <i class="fas fa-file-upload"></i>
                                    Subir Acta de Audiencia
                                </label>
                                <span class="file-name" id="acta-filename">Ningún archivo seleccionado</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="atendida">¿Atendida?</label>
                            <select id="atendida">
                                <option value="false">No</option>
                                <option value="true">Sí</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="recordatorio-dias">Recordatorio Días Antes</label>
                                <input type="number" id="recordatorio-dias" min="1" value="1" placeholder="Ej. 7 días">
                                <small>Por defecto: 1 día antes</small>
                            </div>
                            <div class="form-group">
                                <label for="recordatorio-horas">Recordatorio Horas Antes</label>
                                <input type="number" id="recordatorio-horas" min="1" value="2" placeholder="Ej. 24 horas">
                                <small>Por defecto: 2 horas antes</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales sobre la audiencia..."></textarea>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-audiencia">Cancelar</button>
                <button class="btn btn-success" id="save-audiencia">Guardar Audiencia</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-comentarios">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Comentarios de la audiencia</h2>
                <button class="btn btn-danger" id="close-modal-comentarios">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="comentarios-audiencia-id">
                <div class="form-group">
                    <label for="nuevo-comentario">Nuevo comentario</label>
                    <textarea id="nuevo-comentario" rows="3" placeholder="Escribe tu comentario..."></textarea>
                </div>
                <div class="modal-footer" style="padding-left: 0;">
                    <button class="btn btn-success" id="save-comentario">
                        <i class="fas fa-paper-plane"></i> Guardar comentario
                    </button>
                </div>
                <hr>
                <div>
                    <h3 style="margin-top: 0;">Historial</h3>
                    <ul id="lista-comentarios" class="comment-list" style="list-style: none; padding-left: 0; margin: 0;">
                        </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-tipos-audiencia">
        <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h2>Gestionar tipos de audiencia</h2>
            <button class="btn btn-danger" id="close-modal-tipos"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="form-row" style="grid-template-columns: 1fr auto;">
            <div class="form-group" style="margin-bottom:0;">
                <label for="nuevo-tipo-audiencia">Nuevo tipo</label>
                <input type="text" id="nuevo-tipo-audiencia" placeholder="Ej. Audiencia de conciliación">
            </div>
            <div class="form-group" style="margin-bottom:0; align-self:end;">
                <button class="btn btn-success" id="add-tipo-btn"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            </div>
    
            <hr style="margin:16px 0;">
    
            <h3 style="margin:0 0 10px 0;">Lista de tipos</h3>
            <ul id="lista-tipos-audiencia" style="list-style:none; padding-left:0; margin:0;">
            </ul>
            <small style="color:#666; display:block; margin-top:10px;">
            </Dsmall>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="cancel-tipos">Cerrar</button>
            <button class="btn btn-success" id="save-tipos">Guardar cambios</button>
        </div>
        </div>
    </div>
    
    <div class="modal" id="modal-finalizar-audiencia">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Finalizar Audiencia</h2>
                <button class="btn btn-danger" id="close-modal-finalizar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finalizar-audiencia-id">
                <div class="alert-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #856404;">¿Seguro que quieres finalizar esta audiencia?</h3>
                    <p style="margin: 0; color: #856404;">Esta audiencia la podrás visualizar en la Agenda General</p>
                </div>
                <div class="form-group">
                    <label for="observaciones-finales">Observaciones Finales</label>
                    <textarea id="observaciones-finales" rows="4" placeholder="Escribe las observaciones finales de la audiencia..." required></textarea>
                    <small>Las observaciones son obligatorias para finalizar la audiencia</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-finalizar">Cancelar</button>
                <button class="btn btn-success" id="confirmar-finalizar">
                    <i class="fas fa-check"></i> Finalizar Audiencia
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-historial-cambios">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Historial de cambios</h2>
        <button class="btn btn-danger" id="close-modal-historial">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Audiencia</label>
          <input type="text" class="readonly-field" readonly value="(Demo) ID seleccionado">
        </div>
        <hr>
        <ul style="list-style:none; padding-left:0; margin:0;">
          <li style="padding:8px 0; border-bottom:1px solid #eee;">
            <strong>Pedrito Sola</strong> cambió <em>Hora</em> de <code>10:00</code> a <code>11:30</code> — <small>2025-11-03 14:22</small>
          </li>
          <li style="padding:8px 0; border-bottom:1px solid #eee;">
            <strong>Lic. Carlos H. López</strong> adjuntó <em>Acta de audiencia</em> — <small>2025-11-02 09:10</small>
          </li>
          <li style="padding:8px 0;">
            <strong>Admin</strong> creó la audiencia — <small>2025-11-01 16:05</small>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="cancel-historial">Cerrar</button>
      </div>
    </div>
  </div>
  

    <script src="js/notificaciones.js"></script>
    <script src="js/excel-export.js"></script>
    <script src="js/audiencias.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initAudiencias === 'function') {
                initAudiencias();
            }
            initModalAudiencias();
            initModalComentarios();
            initModalFinalizarAudiencia();
        });

        function initModalAudiencias() {
            // Modal de audiencias
            const modalAudiencia = document.getElementById('modal-audiencia');
            const btnAddAudiencia = document.getElementById('add-audiencia');
            const btnCloseAudiencia = document.getElementById('close-modal-audiencia');
            const btnCancelAudiencia = document.getElementById('cancel-audiencia');
            const btnSaveAudiencia = document.getElementById('save-audiencia');

            // Abrir modal
            if (btnAddAudiencia) {
                btnAddAudiencia.addEventListener('click', function() {
                    openAudienciaModal();
                });
            }

            // Cerrar modal
            if (btnCloseAudiencia) {
                btnCloseAudiencia.addEventListener('click', function() {
                    modalAudiencia.style.display = 'none';
                });
            }

            if (btnCancelAudiencia) {
                btnCancelAudiencia.addEventListener('click', function() {
                    modalAudiencia.style.display = 'none';
                });
            }

            // Guardar audiencia
            if (btnSaveAudiencia) {
                btnSaveAudiencia.addEventListener('click', function() {
                    saveAudiencia();
                });
            }

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target === modalAudiencia) {
                    modalAudiencia.style.display = 'none';
                }
            });
        }

        function initModalComentarios() {
            // Initialize comments modal functionality
            const modalComentarios = document.getElementById('modal-comentarios');
            const btnCloseComentarios = document.getElementById('close-modal-comentarios');
            const btnSaveComentario = document.getElementById('save-comentario');

            if (btnCloseComentarios) {
                btnCloseComentarios.addEventListener('click', function() {
                    modalComentarios.style.display = 'none';
                });
            }

            if (btnSaveComentario) {
                btnSaveComentario.addEventListener('click', function() {
                    const comentario = document.getElementById('nuevo-comentario').value;
                    if (comentario.trim()) {
                        alert('Comentario guardado: ' + comentario);
                        document.getElementById('nuevo-comentario').value = '';
                        modalComentarios.style.display = 'none';
                    }
                });
            }
        }

        function initModalFinalizarAudiencia() {
            const modalFinalizar = document.getElementById('modal-finalizar-audiencia');
            const btnCloseFinalizar = document.getElementById('close-modal-finalizar');
            const btnCancelFinalizar = document.getElementById('cancel-finalizar');
            const btnConfirmarFinalizar = document.getElementById('confirmar-finalizar');

            if (btnCloseFinalizar) {
                btnCloseFinalizar.addEventListener('click', function() {
                    modalFinalizar.style.display = 'none';
                });
            }

            if (btnCancelFinalizar) {
                btnCancelFinalizar.addEventListener('click', function() {
                    modalFinalizar.style.display = 'none';
                });
            }

            if (btnConfirmarFinalizar) {
                btnConfirmarFinalizar.addEventListener('click', function() {
                    const audienciaId = document.getElementById('finalizar-audiencia-id').value;
                    const observaciones = document.getElementById('observaciones-finales').value.trim();
                    
                    if (!observaciones) {
                        alert('Las observaciones son obligatorias para finalizar la audiencia');
                        return;
                    }

                    // Aquí se implementaría la lógica para finalizar la audiencia
                    // Por ahora solo mostramos un mensaje de confirmación
                    alert('Audiencia finalizada correctamente.\nObservaciones: ' + observaciones + '\n\nPodrás visualizar esta audiencia en la Agenda General.');
                    
                    // Cerrar modal y limpiar
                    modalFinalizar.style.display = 'none';
                    document.getElementById('observaciones-finales').value = '';
                    
                    
                    // Ocultar la fila de la tabla
                    const boton = document.querySelector(`.finalizar-audiencia[data-id="${audienciaId}"]`);
                    if (boton) {
                        // 1. Encontrar la fila principal (TR)
                        const fila = boton.closest('tr');
                        // 2. Encontrar la fila expandible (la que sigue)
                        const filaExpandible = fila.nextElementSibling;

                        if (fila) fila.style.display = 'none';
                        if (filaExpandible) filaExpandible.style.display = 'none';
                    }
                    });
            }

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target === modalFinalizar) {
                    modalFinalizar.style.display = 'none';
                }
            });
        }

        function openFinalizarAudienciaModal(audienciaId) {
            const modal = document.getElementById('modal-finalizar-audiencia');
            document.getElementById('finalizar-audiencia-id').value = audienciaId;
            document.getElementById('observaciones-finales').value = '';
            modal.style.display = 'flex';
        }

        function openAudienciaModal(audiencia = null) {
            const modal = document.getElementById('modal-audiencia');
            const title = document.getElementById('modal-audiencia-title');
            const form = document.getElementById('form-audiencia');
            
            if (audiencia) {
                // Modo edición
                title.textContent = 'Editar Audiencia';
                document.getElementById('save-audiencia').textContent = 'Actualizar Audiencia';
                document.getElementById('audiencia-id').value = audiencia.id;
                
                // Datos del asunto (auto-llenados) - mapear desde los datos existentes
                if (audiencia.asuntoId) {
                    document.getElementById('asunto-selector-audiencia').value = audiencia.asuntoId;
                    // Disparar evento para auto-llenar campos del asunto
                    const event = new Event('change');
                    document.getElementById('asunto-selector-audiencia').dispatchEvent(event);
                } else {
                    // Si no hay asuntoId, simular los datos desde los campos existentes
                    document.getElementById('expediente-auto-audiencia').value = audiencia.expediente || '';
                    document.getElementById('materia-auto-audiencia').value = audiencia.materia || '';
                    document.getElementById('gerencia-auto-audiencia').value = audiencia.gerencia || '';
                    document.getElementById('abogado-auto-audiencia').value = audiencia.abogadoEncargado || '';
                    document.getElementById('partes-auto-audiencia').value = `${audiencia.actor || ''} vs ${audiencia.demandado || ''}`;
                    document.getElementById('organo-auto-audiencia').value = audiencia.tribunal || '';
                    document.getElementById('prioridad-auto-audiencia').value = audiencia.prioridad || '';
                }
                
                // Datos específicos de la audiencia - mapear nombres de campos
                document.getElementById('tipo-audiencia').value = audiencia.tipoAudiencia || audiencia.tipo || '';
                document.getElementById('fecha-audiencia').value = audiencia.fechaAudiencia || audiencia.fecha || '';
                document.getElementById('hora-audiencia').value = audiencia.horaAudiencia || audiencia.hora || '';
                
                // Mapear abogado que comparece (puede ser nombre o ID)
                const abogadoComparece = audiencia.abogadoComparece || '';
                if (abogadoComparece) {
                    // Si es un nombre, intentar mapear a ID
                    const abogadoSelect = document.getElementById('abogado-comparece');
                    let found = false;
                    for (let option of abogadoSelect.options) {
                        if (option.text.includes(abogadoComparece) || option.value == abogadoComparece) {
                            abogadoSelect.value = option.value;
                            found = true;
                            break;
                        }
                    }
                    if (!found && typeof abogadoComparece === 'number') {
                        abogadoSelect.value = abogadoComparece;
                    }
                }
                
                document.getElementById('observaciones').value = audiencia.observaciones || '';
                document.getElementById('atendida').value = audiencia.atendida ? 'true' : 'false';
                document.getElementById('recordatorio-dias').value = audiencia.recordatorioDias || 1;
                document.getElementById('recordatorio-horas').value = audiencia.recordatorioHoras || 2;
                
                // Actualizar nombre del archivo si existe
                const actaFilename = document.getElementById('acta-filename');
                const actaDoc = audiencia.actaDocumento || audiencia.actaNombre || '';
                if (actaDoc) {
                    actaFilename.textContent = actaDoc;
                    actaFilename.classList.add('has-file');
                } else {
                    actaFilename.textContent = 'Ningún archivo seleccionado';
                    actaFilename.classList.remove('has-file');
                }
                
            } else {
                // Modo nueva audiencia
                title.textContent = 'Nueva Audiencia';
                document.getElementById('save-audiencia').textContent = 'Guardar Audiencia';
                if (form) form.reset();
                document.getElementById('audiencia-id').value = '';
                
                // Limpiar campos auto-llenados
                if (typeof limpiarCamposAutoLlenadosAudiencia === 'function') {
                    limpiarCamposAutoLlenadosAudiencia();
                }
                
                // Resetear archivo
                const actaFilename = document.getElementById('acta-filename');
                actaFilename.textContent = 'Ningún archivo seleccionado';
                actaFilename.classList.remove('has-file');
            }
            
            modal.style.display = 'flex';
        }

                const DEFAULT_TIPOS_AUDIENCIA = [
        'Inicial','Intermedia','Ratificación','Admisión',
        'Confesional','Reanudación','Incidental','Constitucional'
        ];

        function getTiposAudiencia() {
        try {
            const raw = localStorage.getItem('tiposAudiencia');
            if (raw) {
            const arr = JSON.parse(raw);
            // Limpieza básica
            return Array.from(new Set(arr.filter(Boolean))).sort(caseInsensitiveSort);
            }
        } catch (e) {}
        // Si no hay en storage, guardamos defaults y devolvemos copia
        setTiposAudiencia(DEFAULT_TIPOS_AUDIENCIA);
        return [...DEFAULT_TIPOS_AUDIENCIA].sort(caseInsensitiveSort);
        }

        function setTiposAudiencia(arr) {
        const clean = Array.from(new Set((arr || []).map(s => (s || '').trim()).filter(Boolean)));
        localStorage.setItem('tiposAudiencia', JSON.stringify(clean));
        }

        function caseInsensitiveSort(a, b) {
        return a.localeCompare(b, 'es', { sensitivity: 'base' });
        }

        // Inyecta los tipos en el select del formulario y en el filtro
        function renderTipoOptions() {
        const tipos = getTiposAudiencia();

        // Formulario
        const selForm = document.getElementById('tipo-audiencia');
        if (selForm) {
            selForm.innerHTML = '<option value="">Seleccione un tipo</option>' +
            tipos.map(t => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');
        }

        // Filtro
        const selFiltro = document.getElementById('filter-tipo');
        if (selFiltro) {
            const current = selFiltro.value; // intenta conservar selección
            selFiltro.innerHTML = '<option value="">Todos los tipos</option>' +
            tipos.map(t => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');
            // restaurar selección si aplica
            if ([...selFiltro.options].some(o => o.value === current)) selFiltro.value = current;
        }
        }

        // Modal gestión
        function initGestionTiposAudiencia() {
        const modal = document.getElementById('modal-tipos-audiencia');
        const btnOpen = document.getElementById('manage-tipos-btn');
        const btnClose = document.getElementById('close-modal-tipos');
        const btnCancel = document.getElementById('cancel-tipos');
        const btnSave = document.getElementById('save-tipos');
        const btnAdd = document.getElementById('add-tipo-btn');
        const inputNuevo = document.getElementById('nuevo-tipo-audiencia');
        const ul = document.getElementById('lista-tipos-audiencia');

        let workingList = getTiposAudiencia();

        function open() {
            workingList = getTiposAudiencia();
            renderList();
            modal.style.display = 'flex';
            inputNuevo.value = '';
            inputNuevo.focus();
        }

        function close() {
            modal.style.display = 'none';
        }

        function renderList() {
            if (!ul) return;
            if (!workingList.length) {
            ul.innerHTML = `<li style="color:#666;">Sin tipos registrados.</li>`;
            return;
            }
            ul.innerHTML = workingList.map((t, idx) => `
            <li style="display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #eee;">
                <span style="flex:1;" data-idx="${idx}" class="tipo-text">${escapeHTML(t)}</span>
                <button class="btn btn-info btn-sm edit-tipo" data-idx="${idx}" title="Editar"><i class="fas fa-pen"></i></button>
                <button class="btn btn-danger btn-sm del-tipo" data-idx="${idx}" title="Eliminar"><i class="fas fa-trash"></i></button>
            </li>
            `).join('');

            // Wire up acciones
            ul.querySelectorAll('.edit-tipo').forEach(b => {
            b.addEventListener('click', () => {
                const i = parseInt(b.getAttribute('data-idx'), 10);
                const actual = workingList[i] || '';
                const nuevo = prompt('Editar tipo de audiencia:', actual);
                if (nuevo === null) return; // cancelado
                const normalized = (nuevo || '').trim();
                if (!normalized) return alert('El tipo no puede estar vacío.');
                if (existsIgnoringCase(workingList, normalized, i)) {
                return alert('Ya existe un tipo con ese nombre.');
                }
                workingList[i] = normalized;
                workingList.sort(caseInsensitiveSort);
                renderList();
            });
            });

            ul.querySelectorAll('.del-tipo').forEach(b => {
            b.addEventListener('click', () => {
                const i = parseInt(b.getAttribute('data-idx'), 10);
                const nombre = workingList[i];
                if (!confirm(`¿Eliminar el tipo "${nombre}"?`)) return;
                workingList.splice(i, 1);
                renderList();
            });
            });
        }

        function existsIgnoringCase(arr, value, ignoreIndex = -1) {
            return arr.some((x, idx) => idx !== ignoreIndex && x.localeCompare(value, 'es', { sensitivity: 'base' }) === 0);
        }

        // Abrir / cerrar
        if (btnOpen) btnOpen.addEventListener('click', open);
        if (btnClose) btnClose.addEventListener('click', close);
        if (btnCancel) btnCancel.addEventListener('click', close);
        window.addEventListener('click', function(e) {
            if (e.target === modal) close();
        });

        // Agregar nuevo
        if (btnAdd) btnAdd.addEventListener('click', () => {
            const val = (inputNuevo.value || '').trim();
            if (!val) return alert('Escribe un nombre para el nuevo tipo.');
            if (existsIgnoringCase(workingList, val)) return alert('Ese tipo ya existe.');
            workingList.push(val);
            workingList.sort(caseInsensitiveSort);
            inputNuevo.value = '';
            renderList();
        });

        // Guardar cambios
        if (btnSave) btnSave.addEventListener('click', () => {
            setTiposAudiencia(workingList);
            renderTipoOptions(); // refresca selects
            close();
        });
        }

        // Asegura que los selects se pueblen al cargar
        document.addEventListener('DOMContentLoaded', function () {
        try {
            // Si no existe la lista en localStorage, se crea
            if (!localStorage.getItem('tiposAudiencia')) {
            setTiposAudiencia(DEFAULT_TIPOS_AUDIENCIA);
            }
            renderTipoOptions();
            initGestionTiposAudiencia();
        } catch (e) {
            console.warn('No se pudieron inicializar los tipos de audiencia:', e);
        }
        });

        // Valida antes de guardar audiencia que el tipo exista (por si el usuario manipuló el DOM)
        (function patchGuardarAudienciaParaValidarTipo() {
        if (typeof guardarAudiencia !== 'function') return; // si no existe, no parchamos
        const _orig = guardarAudiencia;
        window.guardarAudiencia = function() {
            const tipo = (document.getElementById('tipo-audiencia')?.value || '').trim();
            const tipos = getTiposAudiencia();
            const existe = tipos.some(t => t.localeCompare(tipo, 'es', { sensitivity: 'base' }) === 0);
            if (!existe) {
            alert('El tipo seleccionado no es válido. Por favor, elige uno de la lista o crea uno nuevo en “Gestionar tipos”.');
            return;
            }
            _orig(); // ejecutar flujo original
        }
        })();

        
    </script>
    
    <script src="js/components.js"></script>
    <script>
        // Configurar página actual para el sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar sidebar y marcar la página activa
            if (typeof loadSidebar === 'function') {
                loadSidebar('audiencias.html');
            }
        });
    </script>
</body>
</html>