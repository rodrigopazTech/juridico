<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Agenda Legal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">

    <style>
        .checkbox-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            max-height: 180px; /* Altura máxima antes de mostrar scroll */
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .checkbox-container div {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
        }
        .checkbox-container label {
            margin-bottom: 0; 
            font-weight: normal; 
        }

        /* Estilos para la nueva tabla de materias en el modal */
        #tabla-gerencia-materias {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        #tabla-gerencia-materias th,
        #tabla-gerencia-materias td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #tabla-gerencia-materias th {
            background-color: #f2f2f2;
        }
        #tabla-gerencia-materias .actions {
            text-align: center;
        }
        #form-add-gerencia-materia {
            display: flex;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        #form-add-gerencia-materia input {
            flex-grow: 1;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    
    <div class="main-content">
        <div class="container">
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-users"></i> Gestión de Usuarios - Agenda Legal</h1>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i> Usuario Subdirector
                    </div>
                </div>
            </header>
            
            <div class="tabs">
                <button class="tab-button active" data-tab="usuarios">
                    <i class="fas fa-users"></i> Usuarios
                </button>
                <button class="tab-button" data-tab="gerencias">
                    <i class="fas fa-home"></i> Gerencias
                </button>
            </div>

            <div class="tab-content active" id="usuarios">
                <div class="toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-usuarios" placeholder="Buscar usuarios...">
                    </div>
                    <button class="btn btn-primary" id="add-usuario">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </button>
                </div>
                <div class="filters">
                    <div class="filters-title">
                        <i class="fas fa-filter"></i> Filtros de Usuarios
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filter-rol">Rol</label>
                            <select id="filter-rol">
                                <option value="">Todos los roles</option>
                                <option value="SUBDIRECTOR">Subdirector</option>
                                <option value="GERENTE">Gerente</option>
                                <option value="ABOGADO">Abogado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-activo">Estado</label>
                            <select id="filter-activo">
                                <option value="">Todos los estados</option>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tabla-usuarios">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Gerencia</th> <th>Estado</th>
                                <th>Fecha de Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-body">
                        </tbody>
                    </table>                </div>
            </div>

            <div class="tab-content" id="gerencias">
                <div class="toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-gerencias" placeholder="Buscar gerencias...">
                    </div>
                    <button class="btn btn-primary" id="add-gerencia">
                        <i class="fas fa-plus"></i> Nueva Gerencia
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="tabla-gerencias">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre de la Gerencia</th>
                                <th>Materias Asignadas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="gerencias-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-usuario">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-usuario-title">Nuevo Usuario</h2>
                <button class="btn btn-danger" id="close-modal-usuario">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-usuario">
                    <input type="hidden" id="usuario-id">
                    <div class="form-group">
                        <label for="usuario-nombre">Nombre Completo *</label>
                        <input type="text" id="usuario-nombre" required placeholder="Ej. Lic. María González Ruiz">
                    </div>
                    <div class="form-group">
                        <label for="usuario-correo">Correo Electrónico *</label>
                        <input type="email" id="usuario-correo" required placeholder="usuario@empresa.com">
                    </div>
                    <div class="form-group">
                        <label for="usuario-contraseña">Contraseña *</label>
                        <input type="password" id="usuario-contraseña" required placeholder="Mínimo 8 caracteres">
                        <small>La contraseña debe tener al menos 8 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label for="usuario-rol">Rol *</label>
                        <select id="usuario-rol" required>
                            <option value="">Seleccione un rol</option>
                            <option value="SUBDIRECTOR">Subdirector</option>
                            <option value="GERENTE">Gerente</option>
                            <option value="ABOGADO">Abogado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="usuario-gerencia">Gerencia *</label>
                        <select id="usuario-gerencia" required>
                            <option value="">Seleccione una gerencia</option>
                            </select>
                    </div>
                    <div class="form-group" id="usuario-materias-group" style="display: none;">
                        <label>Materias Asignadas *</label>
                        <div id="usuario-materias-checkbox-container" class="checkbox-container">
                            </div>
                    </div>
                    <div class="form-group">
                        <label for="usuario-activo">Estado</label>
                        <select id="usuario-activo">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-usuario">Cancelar</button>
                <button class="btn btn-success" id="save-usuario">Guardar Usuario</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-gerencia">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-gerencia-title">Nueva Gerencia</h2>
                <button class="btn btn-danger" id="close-modal-gerencia">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-gerencia">
                    <input type="hidden" id="gerencia-id">

                    <div class="form-group">
                        <label for="gerencia-nombre">Nombre de la Gerencia *</label>
                        <input type="text" id="gerencia-nombre" required placeholder="Ej. Gerencia de Asuntos Civiles y Mercantiles">
                    </div>
                    
                    </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-gerencia">Cancelar</button>
                <button class="btn btn-success" id="save-gerencia">Guardar Gerencia</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-manage-materias">
        <div class="modal-content large"> <div class="modal-header">
                <h2 id="manage-materias-title">Gestionar Materias</h2>
                <button class="btn btn-danger" id="close-modal-manage-materias">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manage-materias-gerencia-id">
                <input type="hidden" id="manage-materias-materia-id"> <h3 id="manage-materias-gerencia-nombre"></h3>
                
                <div class="table-container" style="margin-bottom: 20px;">
                    <table id="tabla-gerencia-materias">
                        <thead>
                            <tr>
                                <th>ID Materia</th>
                                <th>Nombre de la Materia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="gerencia-materias-body">
                            </tbody>
                    </table>
                </div>

                <form id="form-add-gerencia-materia">
                    <input type="text" id="add-materia-nombre" placeholder="Nombre de la materia" required>
                    <button type="submit" class="btn btn-success" id="save-gerencia-materia-btn">
                        <i class="fas fa-plus"></i> Añadir Materia
                    </button>
                    <button type="button" class="btn btn-danger" id="cancel-edit-gerencia-materia-btn" style="display:none;">
                        Cancelar Edición
                    </button>
                </form>

            </div>
            <div class="modal-footer">
                </div>
        </div>
    </div>


    <script src="js/usuarios.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initUsuarios === 'function') {
                initUsuarios();
            }
            initTabs();
            initModalUsuarios();
            // initModalMaterias(); // ELIMINADO
            initModalGerencias();
            initModalManageMaterias(); // <-- AÑADIDO
        });

        // Función para inicializar las pestañas (MODIFICADA)
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    if (targetTab === 'usuarios') {
                        loadUsuarios();
                    // } else if (targetTab === 'materias') { // ELIMINADO
                    //     loadMaterias();
                    } else if (targetTab === 'gerencias') {
                        loadGerencias();
                    }
                });
            });
        }

        // Función para inicializar modal de usuarios (MODIFICADA)
        function initModalUsuarios() {
            const modal = document.getElementById('modal-usuario');
            const btnOpen = document.getElementById('add-usuario');
            const btnClose = document.getElementById('close-modal-usuario');
            const btnCancel = document.getElementById('cancel-usuario');
            const btnSave = document.getElementById('save-usuario');

            if (btnOpen) {
                btnOpen.addEventListener('click', () => openUsuarioModal());
            }
            if (btnClose) {
                btnClose.addEventListener('click', () => modal.style.display = 'none');
            }
            if (btnCancel) {
                btnCancel.addEventListener('click', () => modal.style.display = 'none');
            }
            if (btnSave) {
                btnSave.addEventListener('click', () => saveUsuario());
            }
            
            // Listener para el cambio en el selector de Gerencia (SE MANTIENE)
            const gerenciaSelect = document.getElementById('usuario-gerencia');
            if (gerenciaSelect) {
                gerenciaSelect.addEventListener('change', handleGerenciaChange);
            }

            window.addEventListener('click', (event) => {
                if (event.target === modal) modal.style.display = 'none';
            });
        }

        // initModalMaterias(); // ELIMINADO

        // Función para inicializar modal de gerencias (Sin cambios en su lógica)
        function initModalGerencias() {
            const modal = document.getElementById('modal-gerencia');
            const btnOpen = document.getElementById('add-gerencia');
            const btnClose = document.getElementById('close-modal-gerencia');
            const btnCancel = document.getElementById('cancel-gerencia');
            const btnSave = document.getElementById('save-gerencia');

            if (btnOpen) {
                btnOpen.addEventListener('click', () => openGerenciaModal());
            }
            if (btnClose) {
                btnClose.addEventListener('click', () => modal.style.display = 'none');
            }
            if (btnCancel) {
                btnCancel.addEventListener('click', () => modal.style.display = 'none');
            }
            if (btnSave) {
                btnSave.addEventListener('click', saveGerencia);
            }
            window.addEventListener('click', (event) => {
                if (event.target === modal) modal.style.display = 'none';
            });
        }
        
        // ===== NUEVA FUNCIÓN: INICIALIZAR MODAL GESTIONAR MATERIAS =====
        function initModalManageMaterias() {
            const modal = document.getElementById('modal-manage-materias');
            const btnClose = document.getElementById('close-modal-manage-materias');
            const form = document.getElementById('form-add-gerencia-materia');
            const btnCancelEdit = document.getElementById('cancel-edit-gerencia-materia-btn');

            if (btnClose) {
                btnClose.addEventListener('click', () => modal.style.display = 'none');
            }
            window.addEventListener('click', (event) => {
                if (event.target === modal) modal.style.display = 'none';
            });
            
            // Listener para el formulario de AÑADIR/GUARDAR
            if (form) {
                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    saveGerenciaMateria(); // Función en usuarios.js
                });
            }

            // Listener para el botón de CANCELAR EDICIÓN
            if (btnCancelEdit) {
                btnCancelEdit.addEventListener('click', () => {
                    cancelEditGerenciaMateria(); // Función en usuarios.js
                });
            }
        }

        // Función openUsuarioModal (Sin cambios)
        function openUsuarioModal(usuario = null) {
            const modal = document.getElementById('modal-usuario');
            const title = document.getElementById('modal-usuario-title');
            const form = document.getElementById('form-usuario');
            
            // Ocultar y limpiar el contenedor de checkboxes
            const materiasGroup = document.getElementById('usuario-materias-group');
            const materiasContainer = document.getElementById('usuario-materias-checkbox-container');
            materiasGroup.style.display = 'none';
            materiasContainer.innerHTML = '';

            // Poblar el selector de gerencias (función de usuarios.js)
            populateGerenciasSelect('usuario-gerencia', usuario ? usuario.gerenciaId : null);

            if (usuario) {
                title.textContent = 'Editar Usuario';
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-nombre').value = usuario.nombre;
                document.getElementById('usuario-correo').value = usuario.correo;
                document.getElementById('usuario-contraseña').required = false; 
                document.getElementById('usuario-contraseña').placeholder = "Dejar en blanco para no cambiar";
                document.getElementById('usuario-rol').value = usuario.rol;
                document.getElementById('usuario-activo').value = usuario.activo.toString();
                
                if(usuario.gerenciaId) {
                    handleGerenciaChange(null, usuario.materias || []);
                }

            } else {
                title.textContent = 'Nuevo Usuario';
                form.reset();
                document.getElementById('usuario-contraseña').required = true;
                document.getElementById('usuario-contraseña').placeholder = "Mínimo 8 caracteres";
                document.getElementById('usuario-activo').value = 'true';
                document.getElementById('usuario-gerencia').value = '';
            }
            
            modal.style.display = 'flex';
        }

        // openMateriaModal(); // ELIMINADO

        // Función openGerenciaModal (SIMPLIFICADA)
        function openGerenciaModal(gerencia = null) {
            const modal = document.getElementById('modal-gerencia');
            const title = document.getElementById('modal-gerencia-title');
            const form = document.getElementById('form-gerencia');
            form.reset(); // Limpiar siempre

            if (gerencia) {
                title.textContent = 'Editar Gerencia';
                document.getElementById('gerencia-id').value = gerencia.id;
                document.getElementById('gerencia-nombre').value = gerencia.nombre;
            } else {
                title.textContent = 'Nueva Gerencia';
                document.getElementById('gerencia-id').value = '';
            }
            
            modal.style.display = 'flex';
        }

        // ===== NUEVA FUNCIÓN: ABRIR MODAL GESTIONAR MATERIAS =====
        function openManageMateriasModal(gerenciaId) {
            const modal = document.getElementById('modal-manage-materias');
            const gerencia = getGerencias().find(g => g.id == gerenciaId);
            
            if (!gerencia) {
                alert('Error: No se encontró la gerencia.');
                return;
            }
            
            // Guardar el ID de la gerencia en el modal
            document.getElementById('manage-materias-gerencia-id').value = gerenciaId;
            
            // Poner el nombre en el título
            document.getElementById('manage-materias-gerencia-nombre').textContent = `Gerencia: ${gerencia.nombre}`;
            
            // Resetear el formulario de añadir materia
            cancelEditGerenciaMateria(); // Esta función resetea el form
            
            // Cargar la tabla de materias
            loadGerenciaMaterias(gerenciaId); // Función de usuarios.js
            
            modal.style.display = 'flex';
        }

    </script>
    
    <script src="js/components.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof loadSidebar === 'function') {
                loadSidebar('usuarios.html');
            }
        });
    </script>
</body>
</html>