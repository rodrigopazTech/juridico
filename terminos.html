<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Términos - Agenda Legal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Librería XLSX para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Estilos específicos para el selector de asunto */
        .asunto-selector-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .asunto-selector-section legend {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        #asunto-selector {
            width: 100%;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        #asunto-selector:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        
        .form-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Sidebar de navegación -->
    <div id="sidebar-container"></div>
        
        
    </div>
    
    <!-- Contenido principal -->
    <div class="main-content">
        <div class="container">
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-clock"></i> Términos - Agenda Legal</h1>
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i> Usuario Abogado
                    </div>
                </div>
            </header>
            
            <!-- Tabla de Términos -->
            <div class="tab-content active" id="terminos">
                <div class="toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-terminos" placeholder="Buscar en términos...">
                    </div>
                    <div class="toolbar-buttons">
                        <button class="btn btn-success" id="export-terminos" title="Exportar a Excel">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button class="btn btn-primary" id="add-termino">
                            <i class="fas fa-plus"></i> Nuevo Término
                        </button>
                    </div>
                </div>
                
                <!-- Filtros para términos -->
                <div class="filters">
                    <div class="filters-title">
                        <i class="fas fa-filter"></i> Filtros de Términos
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filter-tribunal-termino">Tribunal</label>
                            <div class="tribunal-search-container">
                                <input type="text" 
                                       id="filter-tribunal-termino" 
                                       placeholder="Buscar tribunal o agregar nuevo..."
                                       autocomplete="off">
                                <div class="tribunal-suggestions" id="tribunal-suggestions">
                                    <!-- Las sugerencias aparecerán aquí -->
                                </div>
                                <button type="button" class="btn-clear-tribunal" id="clear-tribunal" title="Limpiar filtro">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filter-estado-termino">Gerencias</label>
                            <div class="estado-search-container">
                                <input type="text" 
                                       id="filter-estado-termino" 
                                       placeholder="Buscar estado..."
                                       autocomplete="off">
                                <div class="estado-suggestions" id="estado-suggestions">
                                    <!-- Las sugerencias aparecerán aquí -->
                                </div>
                                <button type="button" class="btn-clear-estado" id="clear-estado" title="Limpiar filtro">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filter-estatus-termino">Estatus</label>
                            <select id="filter-estatus-termino">
                                <option value="">Todos los estatus</option>
                                <option value="Proyectista">Proyectista</option>
                                <option value="Liberado">Liberado</option>
                                <option value="Revisión">Revisión</option>
                                <option value="Presentado">Presentado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-prioridad-termino">Prioridad</label>
                            <select id="filter-prioridad-termino">
                                <option value="">Todas las prioridades</option>
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-materia-termino">Materia</label>
                            <select id="filter-materia-termino">
                                <option value="">Todas las materias</option>
                                <option value="Civil">Civil</option>
                                <option value="Penal">Penal</option>
                                <option value="Laboral">Laboral</option>
                                <option value="Mercantil">Mercantil</option>
                                <option value="Fiscal">Fiscal</option>
                                <option value="Familiar">Familiar</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Constitucional">Constitucional</option>
                                <option value="Amparo">Amparo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="tabla-terminos">
                        <thead>
                            <tr>
                                <th>F. Ingreso</th>
                                <th>F. Vencimiento</th>
                                <th>Expediente</th>
                                <th>Actor/Quejoso</th>
                                <th>Asunto</th>
                                <th>Prestación</th>
                                <th>Abogado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="terminos-body">
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/excel-export.js"></script>
    <script src="js/terminos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initTerminos === 'function') {
                initTerminos();
            }
        });
    </script>
    <!-- Modal para Términos -->
    <div class="modal" id="modal-termino">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-termino-title">Nuevo Término</h2>
                <button class="btn btn-danger" id="close-modal-termino">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="form-termino">
                    <input type="hidden" id="termino-id">
                    <input type="hidden" id="termino-asunto-id">
                    
                    <!-- SELECTOR DE ASUNTO -->
                    <fieldset class="asunto-selector-section">
                        <legend>Seleccionar Asunto</legend>
                        
                        <div class="form-group">
                            <label for="asunto-selector">Asunto*</label>
                            <select id="asunto-selector" required>
                                <option value="">Seleccionar Asunto</option>
                            </select>
                            <small class="form-text">Selecciona el asunto al que pertenece este término. Los datos se llenarán automáticamente.</small>
                        </div>
                    </fieldset>
                    
                    <!-- DATOS AUTO-LLENADOS DEL ASUNTO (Solo lectura) -->
                    <fieldset class="auto-filled-section">
                        <legend>Datos del Asunto (Auto-llenados)</legend>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="termino-expediente">Expediente</label>
                                <input type="text" id="termino-expediente" readonly class="readonly-field">
                            </div>
                            <div class="form-group">
                                <label for="termino-materia">Materia</label>
                                <input type="text" id="termino-materia" readonly class="readonly-field">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="termino-gerencia">Gerencia (Estado)</label>
                                <input type="text" id="termino-gerencia" readonly class="readonly-field">
                            </div>
                            <div class="form-group">
                                <label for="termino-abogado">Abogado Responsable</label>
                                <input type="text" id="termino-abogado" readonly class="readonly-field">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="termino-partes">Partes Procesales</label>
                            <input type="text" id="termino-partes" readonly class="readonly-field">
                        </div>
                        
                        <div class="form-group">
                            <label for="termino-tipo-asunto">Tipo de Asunto (Prestación/Procedimiento)</label>
                            <input type="text" id="termino-tipo-asunto" readonly class="readonly-field">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="termino-organo">Órgano Jurisdiccional</label>
                                <input type="text" id="termino-organo" placeholder="Puede editarse si es necesario">
                            </div>
                            <div class="form-group">
                                <label for="termino-prioridad">Prioridad del Asunto</label>
                                <input type="text" id="termino-prioridad" readonly class="readonly-field">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- DATOS ESPECÍFICOS DEL TÉRMINO (Usuario llena) -->
                    <fieldset class="user-input-section">
                        <legend>Datos Específicos del Término</legend>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha-ingreso">Fecha de Ingreso*</label>
                                <input type="date" id="fecha-ingreso" required>
                            </div>
                            <div class="form-group">
                                <label for="fecha-vencimiento">Fecha de Vencimiento*</label>
                                <input type="date" id="fecha-vencimiento" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="actuacion">Actuación (Etapa/Movimiento Procesal)*</label>
                            <textarea id="actuacion" rows="2" required placeholder="Descripción de la etapa procesal o movimiento procesal específico"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="etapa-revision">Etapa de Revisión*</label>
                                <select id="etapa-revision" required>
                                    <option value="">Seleccione etapa</option>
                                    <option value="Proyectista">Proyectista</option>
                                    <option value="Liberado">Liberado</option>
                                    <option value="Revisión">Revisión</option>
                                    <option value="Presentado">Presentado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="atendido">¿Atendido?</label>
                                <select id="atendido">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="acuse-documento">Acuse (Subir Documento)</label>
                            <div class="file-upload-container">
                                <input type="file" id="acuse-documento" accept=".pdf,.doc,.docx" class="file-input">
                                <label for="acuse-documento" class="file-upload-btn">
                                    <i class="fas fa-file-upload"></i>
                                    Subir Acuse del Término
                                </label>
                                <span class="file-name" id="acuse-filename">Ningún archivo seleccionado</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales del término"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recordatorio-dias">Recordatorio Días Antes</label>
                                <input type="number" id="recordatorio-dias" min="1" value="1" placeholder="Ej. 7 días">
                                <small>Por defecto: 1 día antes</small>
                            </div>
                            <div class="form-group">
                                <label for="recordatorio-horas">Recordatorio Horas Antes</label>
                                <input type="number" id="recordatorio-horas" min="1" value="2" placeholder="Ej. 24 horas">
                                <small>Por defecto: 2 horas antes</small>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-termino">Cancelar</button>
                <button class="btn btn-success" id="save-termino">Guardar Término</button>
            </div>
        </div>
    </div>

    <!-- Modal Presentar Término -->
    <div class="modal" id="modal-presentar-termino">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Presentar Término</h2>
                <button class="btn btn-danger" id="close-modal-presentar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="presentar-termino-id">
                <div class="alert-warning" style="background: #d1ecf1; border: 1px solid #b8daff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #0c5460;">¿Confirma que desea presentar este término?</h3>
                    <p style="margin: 0; color: #0c5460;">El término cambiará su estatus a "Presentado" y se mostrará en la Agenda General</p>
                </div>
                <div class="form-group">
                    <label for="observaciones-presentacion">Observaciones de Presentación</label>
                    <textarea id="observaciones-presentacion" rows="4" placeholder="Escriba las observaciones sobre la presentación del término..." required></textarea>
                    <small>Las observaciones son obligatorias para presentar el término</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-presentar">Cancelar</button>
                <button class="btn btn-success" id="confirmar-presentar">Presentar Término</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/notificaciones.js"></script>
    <script src="js/terminos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initTerminos === 'function') {
                initTerminos();
            }
            initModalTerminos();
            setupMateriaFields();
            initExportacionTerminos();
        });
        
        function setupMateriaFields() {
            const materiaSelect = document.getElementById('termino-materia');
            const laboralFields = document.querySelectorAll('.field-laboral');
            const procedimientoFields = document.querySelectorAll('.field-procedimiento');
            const transparenciaFields = document.querySelectorAll('.field-transparencia');
            
            if (materiaSelect) {
                materiaSelect.addEventListener('change', function() {
                    const selectedMateria = this.value;
                    
                    // Ocultar todos los campos específicos con animación
                    const allSpecificFields = document.querySelectorAll('.materia-specific-fields .form-group');
                    allSpecificFields.forEach(field => {
                        field.style.display = 'none';
                        field.classList.remove('field-show');
                    });
                    
                    // Limpiar los campos ocultos
                    document.getElementById('termino-prestacion').value = '';
                    document.getElementById('termino-procedimiento').value = '';
                    document.getElementById('termino-solicitud').value = '';
                    document.getElementById('termino-solicitante').value = '';
                    
                    // Resetear todos los campos como no obligatorios
                    document.getElementById('termino-prestacion').required = false;
                    document.getElementById('termino-solicitud').required = false;
                    document.getElementById('termino-solicitante').required = false;
                    
                    // Mostrar campos según la materia seleccionada con pequeño delay para la animación
                    setTimeout(() => {
                        if (selectedMateria === 'Laboral') {
                            laboralFields.forEach(field => {
                                field.style.display = 'block';
                                field.classList.add('field-show');
                            });
                            document.getElementById('termino-prestacion').required = true;
                        }
                        
                        if (selectedMateria === 'Transparencia') {
                            transparenciaFields.forEach(field => {
                                field.style.display = 'block';
                                field.classList.add('field-show');
                            });
                            document.getElementById('termino-solicitud').required = true;
                            document.getElementById('termino-solicitante').required = true;
                        }
                        
                        // Mostrar procedimiento solo para Mercantil
                        if (selectedMateria === 'Mercantil') {
                            procedimientoFields.forEach(field => {
                                field.style.display = 'block';
                                field.classList.add('field-show');
                            });
                        }
                    }, 50);
                });
            }
        }

        function initModalTerminos() {
            // Modal de términos
            const modalTermino = document.getElementById('modal-termino');
            const btnAddTermino = document.getElementById('add-termino');
            const btnCloseTermino = document.getElementById('close-modal-termino');
            const btnCancelTermino = document.getElementById('cancel-termino');
            const btnSaveTermino = document.getElementById('save-termino');

            // Abrir modal
            if (btnAddTermino) {
                btnAddTermino.addEventListener('click', function() {
                    openTerminoModal();
                });
            }

            // Cerrar modal
            if (btnCloseTermino) {
                btnCloseTermino.addEventListener('click', function() {
                    modalTermino.style.display = 'none';
                });
            }

            if (btnCancelTermino) {
                btnCancelTermino.addEventListener('click', function() {
                    modalTermino.style.display = 'none';
                });
            }

            // Guardar término
            if (btnSaveTermino) {
                btnSaveTermino.addEventListener('click', function() {
                    saveTermino();
                });
            }

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target === modalTermino) {
                    modalTermino.style.display = 'none';
                }
            });
        }

        function openTerminoModal(termino = null) {
            const modal = document.getElementById('modal-termino');
            const title = document.getElementById('modal-termino-title');
            const form = document.getElementById('form-termino');
            
            // Cargar lista de asuntos en el selector
            cargarAsuntosEnSelector();
            
            if (termino) {
                title.textContent = 'Editar Término';
                document.getElementById('save-termino').textContent = 'Actualizar Término';
                document.getElementById('termino-id').value = termino.id;
                
                // Si tiene asunto asociado, seleccionarlo
                if (termino.asuntoId) {
                    document.getElementById('asunto-selector').value = termino.asuntoId;
                    cargarDatosAsuntoEnModal(termino.asuntoId);
                } else {
                    // Si no hay asuntoId, llenar manualmente los campos auto-llenados con los datos existentes
                    document.getElementById('termino-expediente').value = termino.expediente || '';
                    document.getElementById('termino-materia').value = termino.materia || '';
                    document.getElementById('termino-gerencia').value = termino.estado || termino.gerencia || '';
                    document.getElementById('termino-abogado').value = termino.abogado || '';
                    document.getElementById('termino-partes').value = termino.actor || '';
                    document.getElementById('termino-organo').value = termino.tribunal || '';
                    document.getElementById('termino-prioridad').value = termino.prioridad || '';
                }
                
                // Datos específicos del término - mapear nombres de campos
                document.getElementById('fecha-ingreso').value = termino.fechaIngreso || termino.fechaIngreso || '';
                document.getElementById('fecha-vencimiento').value = termino.fechaVencimiento || termino.fechaVencimiento || '';
                document.getElementById('actuacion').value = termino.actuacion || termino.asunto || '';
                document.getElementById('etapa-revision').value = termino.etapaRevision || termino.estatus || '';
                document.getElementById('atendido').value = termino.atendido ? 'true' : 'false';
                document.getElementById('observaciones').value = termino.observaciones || '';
                document.getElementById('recordatorio-dias').value = termino.recordatorioDias || 1;
                document.getElementById('recordatorio-horas').value = termino.recordatorioHoras || 2;
                
                // Manejar archivo de acuse si existe
                const acuseFilename = document.getElementById('acuse-filename');
                if (termino.acuseDocumento) {
                    acuseFilename.textContent = termino.acuseDocumento;
                    acuseFilename.classList.add('has-file');
                } else {
                    acuseFilename.textContent = 'Ningún archivo seleccionado';
                    acuseFilename.classList.remove('has-file');
                }
            } else {
                title.textContent = 'Nuevo Término';
                document.getElementById('save-termino').textContent = 'Guardar Término';
                if (form) form.reset();
                document.getElementById('termino-id').value = '';
                document.getElementById('asunto-selector').value = '';
                
                // Limpiar campos auto-llenados
                limpiarCamposAutoLlenadosModal();
                
                // Resetear archivo
                const acuseFilename = document.getElementById('acuse-filename');
                acuseFilename.textContent = 'Ningún archivo seleccionado';
                acuseFilename.classList.remove('has-file');
                
                // Establecer fecha de hoy como predeterminada
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('fecha-ingreso').value = today;
                
                // Establecer vencimiento en 15 días
                const vencimiento = new Date();
                vencimiento.setDate(vencimiento.getDate() + 15);
                document.getElementById('fecha-vencimiento').value = vencimiento.toISOString().split('T')[0];
            }
            
            // Configurar evento de cambio para el selector de asunto
            const asuntoSelector = document.getElementById('asunto-selector');
            asuntoSelector.removeEventListener('change', handleAsuntoChange); // Evitar duplicados
            asuntoSelector.addEventListener('change', handleAsuntoChange);
            
            modal.style.display = 'flex';
        }
        
        // Función para cargar asuntos en el selector del modal
        function cargarAsuntosEnSelector() {
            const selector = document.getElementById('asunto-selector');
            if (!selector) return;
            
            // Obtener asuntos del localStorage
            const asuntos = JSON.parse(localStorage.getItem('asuntos')) || [];
            
            // Limpiar selector manteniendo la opción por defecto
            selector.innerHTML = '<option value="">Seleccionar Asunto</option>';
            
            // Agregar asuntos al selector
            asuntos.forEach(asunto => {
                const option = document.createElement('option');
                option.value = asunto.id;
                option.textContent = `${asunto.expediente} - ${asunto.descripcion || asunto.partes}`;
                selector.appendChild(option);
            });
        }
        
        // Función para manejar el cambio de asunto
        function handleAsuntoChange() {
            const asuntoId = this.value;
            if (asuntoId) {
                cargarDatosAsuntoEnModal(asuntoId);
                // Guardar el ID del asunto seleccionado
                document.getElementById('termino-asunto-id').value = asuntoId;
            } else {
                limpiarCamposAutoLlenadosModal();
                document.getElementById('termino-asunto-id').value = '';
            }
        }
        
        // Función para cargar datos del asunto seleccionado en el modal
        function cargarDatosAsuntoEnModal(asuntoId) {
            const asuntos = JSON.parse(localStorage.getItem('asuntos')) || [];
            const asunto = asuntos.find(a => a.id === asuntoId);
            
            if (asunto) {
                // Llenar campos auto-llenados del modal
                document.getElementById('termino-expediente').value = asunto.expediente || '';
                document.getElementById('termino-materia').value = asunto.materia || '';
                document.getElementById('termino-gerencia').value = asunto.gerencia || '';
                document.getElementById('termino-abogado').value = asunto.abogado || '';
                document.getElementById('termino-partes').value = asunto.partes || '';
                document.getElementById('termino-organo').value = asunto.organoJurisdiccional || '';
                document.getElementById('termino-prioridad').value = asunto.prioridad || '';
            }
        }
        
        // Función para limpiar los campos auto-llenados del modal
        function limpiarCamposAutoLlenadosModal() {
            const campos = [
                'termino-expediente', 'termino-materia', 'termino-gerencia', 
                'termino-abogado', 'termino-partes', 'termino-organo', 'termino-prioridad'
            ];
            campos.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) campo.value = '';
            });
        }

        function saveTermino() {
            // Llamar a la función de guardar término del archivo JS
            if (typeof guardarTermino === 'function') {
                guardarTermino();
            } else {
                alert('Error: Función guardarTermino no encontrada.');
            }
        }

        function initExportacionTerminos() {
            // Configurar botón de exportar a Excel
            const btnExportTerminos = document.getElementById('export-terminos');
            if (btnExportTerminos) {
                btnExportTerminos.addEventListener('click', function() {
                    console.log('Iniciando exportación de términos...');
                    if (typeof exportarTerminosAExcel === 'function') {
                        exportarTerminosAExcel();
                    } else {
                        alert('Error: La función de exportación no está disponible.');
                        console.error('Función exportarTerminosAExcel no encontrada');
                    }
                });
            } else {
                console.warn('Botón export-terminos no encontrado');
            }
        }
    </script>
    
    <!-- Cargar componentes -->
    <script src="js/components.js"></script>
    <script>
        // Configurar página actual para el sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar sidebar y marcar la página activa
            if (typeof loadSidebar === 'function') {
                loadSidebar('terminos.html');
            }
        });
    </script>
</body>
</html>